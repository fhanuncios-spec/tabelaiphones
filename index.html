<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Lista Apple ‚Ä¢ MANGA & ImportTech</title>

  <style>
    :root{
      --bg:#f5f5f7;
      --card: rgba(255,255,255,.86);
      --stroke: rgba(0,0,0,.08);
      --text:#1d1d1f;
      --muted: rgba(29,29,31,.65);
      --radius:18px;

      --blue:#0a84ff;
      --purple:#5856d6;
      --green:#34c759;

      --btnBg: rgba(10,132,255,.10);
      --btnStroke: rgba(10,132,255,.25);

      --black:#0b0b0f;
      --manga:#0b3d1a;     /* verde escuro */
      --tech:#0a84ff;      /* azul */
    }

    *{box-sizing:border-box; min-width:0;}
    html, body { width:100%; max-width:100%; overflow-x:hidden; }

    body{
      margin:0;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(10,132,255,.12), transparent 60%),
        radial-gradient(1200px 600px at 80% 0%, rgba(88,86,214,.14), transparent 55%),
        var(--bg);
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Display","SF Pro Text","Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    header{
      position:sticky;top:0;z-index:50;
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      background: rgba(245,245,247,.78);
      border-bottom:1px solid var(--stroke);
    }
    .header-inner{
      max-width:1100px;margin:0 auto;
      padding:14px 14px;
      display:flex;align-items:flex-end;justify-content:space-between;gap:12px;
      flex-wrap: wrap;
    }
    .title{display:flex;flex-direction:column;gap:4px}
    .title h1{
      margin:0;font-size:18px;letter-spacing:-.2px;line-height:1.1;
      background: linear-gradient(90deg,var(--blue),var(--purple));
      -webkit-background-clip:text;background-clip:text;color:transparent;
    }
    .title small{color:var(--muted);font-size:12px;overflow-wrap:anywhere}

    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:10px 12px;border-radius:999px;
      background: rgba(255,255,255,.84);
      border:1px solid var(--stroke);
      box-shadow: 0 6px 18px rgba(0,0,0,.06);
      font-size:12px;color:var(--muted);
      max-width:100%;
      white-space: normal;
    }

    .wrap{max-width:1100px;margin:0 auto;padding:18px 14px 42px;width:100%;}
    .block{
      border:1px solid var(--stroke);
      border-radius: 22px;
      background: rgba(255,255,255,.55);
      box-shadow: 0 10px 28px rgba(0,0,0,.06);
      overflow:hidden;
      margin: 14px 0;
      width:100%;
      max-width:100%;
    }

    .block-head{
      padding:14px 14px;
      display:flex;align-items:flex-end;justify-content:space-between;gap:12px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background: var(--black);
      color: #fff;
      flex-wrap: wrap;
    }

    .block-left{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      min-width: 0;
    }

    .store-badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 10px 12px;
      border-radius: 999px;
      font-weight: 850;
      letter-spacing: -.2px;
      font-size: 13px;
      color: #fff;
      border: 1px solid rgba(255,255,255,.14);
      white-space:nowrap;
    }
    .store-badge.manga{ background: var(--manga); }
    .store-badge.tech{ background: var(--tech); }

    .block-sub{
      font-size:12px;
      color: rgba(255,255,255,.75);
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.08);
      max-width: 100%;
      white-space: normal;
    }

    .section{padding: 2px 12px 14px;}
    .section-head{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      margin: 14px 2px 10px;
      flex-wrap:wrap;
    }
    .section-head h3{ margin:0;font-size:15px;letter-spacing:-.2px; }
    .h3-blue{color:var(--blue)}
    .h3-green{color:var(--green)}
    .count{
      color:var(--muted);font-size:12px;
      padding:6px 10px;border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.65);
      white-space:nowrap;
    }

    details.cat{
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      background: rgba(255,255,255,.55);
      overflow:hidden;
      margin-bottom: 10px;
      width:100%;
      max-width:100%;
    }
    details.cat > summary{
      list-style:none;cursor:pointer;
      padding: 12px 12px;
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      flex-wrap:wrap;
    }
    details.cat > summary::-webkit-details-marker{display:none}
    .cat-left{display:flex;flex-direction:column;gap:2px;min-width:0}
    .cat-title{margin:0;font-size:13px;font-weight:760;letter-spacing:-.2px;overflow-wrap:anywhere}
    .cat-sub{font-size:12px;color:var(--muted)}

    .line-block{padding:0 10px 10px; width:100%; max-width:100%;}
    .line-title{
      margin: 10px 2px 8px;
      font-size:12px;color:var(--muted);
      letter-spacing:.2px;text-transform:uppercase;
    }

    .grid{
      display:grid;
      gap:10px;
      width:100%;
      max-width:100%;
      min-width:0;
      grid-template-columns: repeat(auto-fit, minmax(165px, 1fr));
    }
    @media (max-width:360px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      background: var(--card);
      border:1px solid var(--stroke);
      border-radius: 16px;
      padding: 12px;
      box-shadow: 0 10px 24px rgba(0,0,0,.06);
      display:flex;flex-direction:column;gap:10px;
      min-height: 154px;
      width:100%;
      max-width:100%;
      min-width:0;
    }

    .badge{
      align-self:flex-start;
      font-size:11px;
      padding:6px 9px;border-radius:999px;
      border:1px solid rgba(0,0,0,.06);
      background: rgba(0,0,0,.04);
      color: rgba(29,29,31,.72);
      white-space:nowrap;
    }
    .badge.lacrado{
      background: rgba(10,132,255,.10);
      border-color: rgba(10,132,255,.22);
      color: rgba(10,132,255,.95);
    }
    .badge.seminovo{
      background: rgba(52,199,89,.12);
      border-color: rgba(52,199,89,.22);
      color: rgba(52,199,89,.95);
    }
    .badge.upgrade{
      background:#0b6b2b;
      border-color: rgba(255,255,255,.18);
      color:#fff;
    }

    .name{
      margin:0;font-size:13px;font-weight:900;letter-spacing:-.15px;line-height:1.2;
      overflow-wrap:anywhere; word-break: break-word;
    }
    .details{
      margin:0;font-size:12px;color:var(--muted);line-height:1.25;min-height:15px;
      overflow-wrap:anywhere; word-break: break-word;
    }

    .chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:-2px;min-width:0}
    .chip{
      font-size:11px;
      padding:5px 8px;border-radius:999px;
      background: rgba(0,0,0,.035);
      border:1px solid rgba(0,0,0,.06);
      color: rgba(29,29,31,.72);
      max-width: 100%;
      overflow-wrap:anywhere;
    }

    .price-row{
      margin-top:auto;
      display:flex;align-items:flex-end;justify-content:space-between;gap:10px;
      min-width:0;
      flex-wrap: wrap;
    }

    /* ‚úÖ Agora mostra "√† vista ‚Ä¢ 12x ..." na mesma linha */
    .price{
      font-weight:900;letter-spacing:-.2px;font-size:14px;
      white-space: normal;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:baseline;
    }
    .installment{
      font-weight:800;
      font-size:12px;
      color: rgba(29,29,31,.70);
      white-space:nowrap;
    }

    .copy{
      appearance:none;
      border:1px solid var(--btnStroke);
      background: var(--btnBg);
      color: rgba(10,132,255,.95);
      font-weight:900;
      font-size:12px;
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      transition: transform .08s ease, background .2s ease;
      white-space:nowrap;
    }
    .copy:hover{background: rgba(10,132,255,.14)}
    .copy:active{transform:scale(.98)}

    .foot{
      color:var(--muted);
      font-size:12px;
      text-align:center;
      padding: 14px 0 8px;
    }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(29,29,31,.92);
      color:#fff;
      font-size:12px;
      padding: 10px 12px;
      border-radius:999px;
      box-shadow: 0 12px 30px rgba(0,0,0,.25);
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
    }
    .toast.show{opacity:1; transform: translateX(-50%) translateY(-6px);}
  </style>
</head>

<body>
<header>
  <div class="header-inner">
    <div class="title">
      <h1>üçè Lista Apple ‚Ä¢ MANGA & ImportTech</h1>
      <small>Valores √† vista. Parcelado em at√© 18x: consultar.</small>
    </div>
    <div class="pill" id="updatedPill">üìå Atualiza√ß√£o: hoje</div>
  </div>
</header>

<div class="wrap" id="app"></div>
<div class="toast" id="toast">Mensagem copiada ‚úÖ</div>

<script>
/** =========================
 *  0) TAXAS DA M√ÅQUINA (edite aqui quando mudar)
 *  ========================= */
const CARD_FEES = {
  credit: {
    12: 0.1070
  }
};

/** Converte "R$ 3.450,00" -> 3450.00 */
function parseBRL(brl){
  if (!brl) return NaN;
  const s = String(brl)
    .replace(/[^\d.,-]/g,"")
    .replace(/\./g,"")
    .replace(",",".");
  const n = Number(s);
  return Number.isFinite(n) ? n : NaN;
}
function formatBRL(n){
  if (!Number.isFinite(n)) return "";
  return n.toLocaleString("pt-BR", { style:"currency", currency:"BRL" });
}

/**
 * ‚úÖ Quer receber o valor √† vista "limpo":
 * cliente paga: vista / (1 - taxa)
 */
function calcParcela12FromCash(cashValue){
  const fee = CARD_FEES.credit?.[12];
  if (!Number.isFinite(cashValue) || !fee) return null;
  const total = cashValue / (1 - fee);
  const parcela = total / 12;
  return { parcela };
}

/** =========================
 *  1) LISTAS (ATUALIZE TODO DIA AQUI)
 *  ========================= */
const RAW_MANGA = String.raw`
IPHONE LACRADOüì¶

**iPad**

üìç IPAD 11 128 * (A16) silver *R$ 2950,00*

üìç IPAD 11 256 * (A16) azul *R$ 3400,00*

üìç MAC MINI (M4) 512GB 16GB MIDNIGHT *R$ 5200,00*

---

**Rel√≥gios**

üìç APLLE WATCH SE 3 44mm preto *R$ 2400,00*

üìç APLLE WATCH S√âRIE 11 42mm preto *R$ 3000,00*

üìç APLLE WATCH S√âRIE 11 46mm preto *R$ 3200,00*

---

**IPHONE**

üìç IPHONE 14 128gb preto *R$ 3800,00*

üìç IPHONE 15 128gb azul e preto *R$ 4150,00*

üìç IPHONE 16 128gb azul *R$ 4800,00*

üìç IPHONE 16 256gb branco / rosa e preto *R$ 5400,00*

üìç IPHONE 17 256 BRANCO / PRETO / LIL√ÅS E AZUL *R$6100,00*

üìç IPHONE 17 pro 256gb laranja *R$ 8200,00*

üìç IPHONE 17 pro 256gb azul *R$ 8300,00*

üìç IPHONE 17 pro Max 256gb laranja *R$ 8700,00*

üìç IPHONE 17 pro Max 256gb azul *R$ 8800,00*

üìç IPHONE 17 pro Max 256gb silver *R$ 9000,00*

üìç IPHONE 17 pro Max 512gb laranja *R$ 10200,00*

IPHONE SEMINOVOSüì±

üìç iPhone 12 Pro Max - grade A 128gb azul ( bateria 90 a 100) *R$ 2950,00*

üìç iPhone 13 Pro - 256GB (UPGRADE) preto ( bateria 100% ) *R$ 3150,00*

üìç iPhone 13 Pro Max - grade A 128gb silver e gold ( bateria 90 a 100) *R$ 3400,00*

üìç iPhone 13 Pro Max - grade A 256gb preto ( bateria 90 a 100) *R$ 3500,00*

üìç iPhone 14 Plus - 128gb grade Ab preto ( bateria 90 a üíØ ) *R$ 2900,00*

üìç iPhone 14 pro - 128gb grade A roxo / silver e preto ( bateria 90 a üíØ ) *R$ 3500,00*

üìç iPhone 15 pro - 128gb grade A natural ( bateria 90 a üíØ ) *R$ 4400,00*

üìç iPhone 15 pro max - 512gb grade A natural ( bateria 90 a üíØ ) *R$ 5000,00*

üìç iPhone 16 pro - 256gb grade A natural e desert ( bateria 90 a üíØ ) *R$ 5400,00*

üìç iPhone 16 pro Max - 256gb grade A natural e desert ( bateria 90 a üíØ ) *R$ 5900,00*

`;

const RAW_TECH = String.raw`
IPHONE SEMINOVOS
üì≤ 12 64gb A *R$ 1.880,00*
ü§çüñ§‚ù§Ô∏èüíô

üì≤ 12 128gb A *R$ 2.000,00*
üíôüíúü§ç

üì≤ 12pro 256gb A *R$ 2.500,00*
üíôü©∂

üì≤ 12pro 512gb A *R$ 2.550,00*
üíô

üì≤ 12 pro max 256gb A *R$ 2.950,00*
üñ§

üì≤ 13 128gb A *R$ 2.550,00*
üñ§üíô‚ù§Ô∏èü§ç

üì≤ 13 256gb A *R$ 2.700,00*
üñ§ü§çü©∑

üì≤ 13 pro 128gb A *R$ 3.050,00*
ü§çüñ§ü©µüíö

üì≤ 13 pro 256gb A *R$ 3.200,00*
üß°ü§ç

üì≤ 13 pro max 128gb A *R$ 3.450,00*
ü©∂üß°ü©µ

üì≤ 13 pro max 256gb A *R$ 3.600,00*
ü§çüñ§üß°ü©µ

üì≤ 14 128gb A *R$ 2.700,00*
ü©µüñ§üíú

üì≤ 14 128gb AB *R$ 2.500,00*
üñ§

üì≤ 14 256gb A *R$ 2.800,00*
ü§ç

üì≤ 14 Plus 128gb A *R$ 2.950,00*
‚ù§Ô∏èüíõüíúü©µüñ§

üì≤ 14 Plus 256gb A *R$ 3.050,00*
üñ§ü§çüíú

üì≤ 14 pro 128gb A *R$ 3.400,00*
üñ§

üì≤ 14 pro 128gb AB *R$ 3.100,00*
üñ§

üì≤ 14 pro 256gb A *R$ 3.600,00*
üñ§ü§çüß°

üì≤ 14 pro max 256gb A *R$ 4.050,00*
üñ§

üì≤ 15 128gb A *R$ 3.450,00*
ü©∑ü©µ

üì≤ 15 Plus 128gb A *R$ 3.650,00*
üñ§ü©µü©∑

üì≤ 15 pro 128gb A *R$ 4.150,00*
üíô

üì≤ 15 pro 256gb A *R$ 4.300,00*
ü§çü©∂üíô

üì≤ 15 pro max 256gb A *R$ 4.950,00*
üñ§üíôü©∂

üì≤ 15 pro max 512gb A *R$ 5.050,00*
ü©∂üíô

üì≤ 15 pro max 1T A *R$ 5.150,00*
üíôüñ§

üì±16 128gb A *R$ 4.250,00*
üñ§ üíô

üì≤ 16 plus 128gb A *R$ 4.750,00*
üñ§

üì≤ 16 pro 128gb A *R$ 5.100,00*
ü©∂ü§çüß°

üì≤ 16 pro max 256gb A *R$ 6.190,00*
ü§çüß°ü©∂

üì≤ 16pro Max 1T A *R$ 6.499,00*
üñ§
`;

/** =========================
 *  2) MENSAGENS (COPIAR)
 *  ========================= */
const TEMPLATE_LACRADO = (model, price, installment12Txt, colorsTxt) => `Eu tenho o ${model} lacrado, com garantia oficial Apple! üì¶
est√° saindo por ${price}${installment12Txt ? ` ‚Ä¢ ou 12x de ${installment12Txt}` : ""}.

${colorsTxt ? `üé® Cores dispon√≠veis: ${colorsTxt}\n\n` : ""}üì¶ Ele √©:
‚úÖ Totalmente novo, lacrado na caixa original
‚úÖ Produto 100% original e com nota fiscal no seu nome
‚úÖ Vai completo com cabo, manual e tudo certinho da Apple`;

const TEMPLATE_SEMINOVO = (model, price, installment12Txt, colorsTxt) => `Eu tenho o ${model} seminovo, em perfeito estado! üì¶
est√° saindo por ${price}${installment12Txt ? ` ‚Ä¢ ou 12x de ${installment12Txt}` : ""}.

${colorsTxt ? `üé® Cores dispon√≠veis: ${colorsTxt}\n\n` : ""}üì¶ Seminovos:
‚úÖ 6 meses de garantia pela loja
‚úÖ Nota fiscal no seu nome
‚úÖ Capa + Pel√≠cula + Carregador completo de brinde
‚úÖ Aparelho 100% original, super conservado e testado pela nossa equipe t√©cnica`;

/** =========================
 *  3) PARSER
 *  ========================= */
const DEFAULT_STATUS = "LACRADOS";

const EMOJI_COLOR_MAP = new Map([
  ["üñ§","preto"], ["ü§ç","branco"], ["üíô","azul"], ["ü©∂","cinza"],
  ["ü©∑","rosa"], ["üíú","roxo"], ["ü©µ","azul claro"], ["‚ù§Ô∏è","vermelho"],
  ["üß°","laranja"], ["üíõ","amarelo"], ["üíö","verde"],
]);

function normalizeLine(s){ return (s||"").replace(/\r/g,"").trim(); }

function detectStatus(line){
  const t = line.toUpperCase();
  if (t.includes("SEMINOVO")) return "SEMINOVOS";
  if (t.includes("LACRADO")) return "LACRADOS";
  return null;
}

function isCategoryLine(line){ return /^\*\*.+\*\*$/.test(line.trim()); }
function parseCategory(line){ return line.trim().replace(/^\*\*|\*\*$/g,"").trim(); }

function guessCategoryFromText(line){
  const t = line.toUpperCase();
  if (t.includes("IPAD")) return "iPad";
  if (t.includes("REL√ìG") || t.includes("RELOG")) return "Rel√≥gios";
  if (t.includes("WATCH")) return "Rel√≥gios";
  if (t.includes("MAC")) return "Mac";
  if (t.includes("IPHONE")) return "iPhone";
  return null;
}

function parseItemLine(line){
  const raw = line.replace(/^(üìç|üì≤|üì±)\s*/,"").trim();
  const priceMatch = raw.match(/\*?\s*R\$\s*[\d.]+(?:,\d{2})?\s*\*?/i);
  const price = priceMatch ? priceMatch[0].replace(/\*/g,"").trim() : "";
  const name = priceMatch ? raw.replace(priceMatch[0], "").replace(/\*+/g,"").trim() : raw;

  const parts = name.split(" * ").map(x=>x.trim()).filter(Boolean);
  const title = parts[0] || name;
  const details = parts.slice(1).join(" ‚Ä¢ ");

  return { title, details, price, raw: name };
}

function capitalizeBrand(s){
  return (s || "")
    .replace(/\bIPHONE\b/ig,"iPhone")
    .replace(/\bIPAD\b/ig,"iPad")
    .replace(/\bAPPLE\b/ig,"Apple")
    .replace(/\s+/g," ")
    .trim();
}

function extractColorsFromWords(text){
  const t = (text || "").toLowerCase();
  const COLORS = [
    "preto","branco","azul","rosa","verde","vermelho","amarelo","roxo","cinza","grafite",
    "prata","dourado","bege","laranja",
    "silver","midnight","starlight","gold","graphite","space gray","spacegrey","natural","desert"
  ];

  const afterStorage = t.split(/\b(64|128|256|512)\s*gb\b|\b1\s*tb\b|\b2\s*tb\b|\b1\s*t\b/).pop() || t;
  const normalized = afterStorage.replace(/\s+/g," ").trim();

  const hits = [];
  for (const c of COLORS){
    const needle = c.toLowerCase();
    if (needle.includes(" ")){
      if (normalized.includes(needle) && !hits.includes(c)) hits.push(c);
    }else{
      const re = new RegExp(`\\b${needle}\\b`,"i");
      if (re.test(normalized) && !hits.includes(c)) hits.push(c);
    }
  }

  normalized.split(/\/|,| e /i).map(s=>s.trim()).forEach(p=>{
    if (COLORS.includes(p) && !hits.includes(p)) hits.push(p);
  });

  return hits;
}

function extractColorsFromEmojiLine(line){
  const chars = Array.from((line || "").trim());
  const out = [];
  for (const ch of chars){
    if (EMOJI_COLOR_MAP.has(ch) && !out.includes(ch)) out.push(ch);
  }
  return out;
}

function colorsTextForMessage(item){
  const parts = [];
  if (item.colorsWords && item.colorsWords.length) parts.push(item.colorsWords.join(" / "));
  if (item.colorsEmoji && item.colorsEmoji.length){
    const names = item.colorsEmoji.map(e=>EMOJI_COLOR_MAP.get(e)).filter(Boolean);
    if (names.length) parts.push(names.join(" / "));
  }
  const merged = parts.join(" / ").split(" / ").map(s=>s.trim()).filter(Boolean);
  const unique = [];
  for (const m of merged){ if (!unique.includes(m)) unique.push(m); }
  return unique.join(" / ");
}

function extractCapacity(text){
  const s = (text || "");
  const m = s.match(/\b(64|128|256|512)\s*gb\b|\b1\s*tb\b|\b2\s*tb\b|\b1\s*t\b/i);
  if (!m) return "";
  return m[0].toUpperCase().replace(/\s+/g,"").replace("T","TB");
}

function cleanModelOnly(text){
  let s = (text || "")
    .replace(/\(.*?\)/g," ")
    .replace(/\bgrade\s*[a-z]+\b/ig," ")
    .replace(/\bUPGRADE\b/ig," ")
    .replace(/\bGARANTIA\b/ig," ")
    .replace(/\bBATERIA\b/ig," ")
    .replace(/\bCPO\b/ig," ")
    .replace(/\bM[E√ä]S\b/ig," ")
    .replace(/\bNOTA\s*FISCAL\b/ig," ")
    .replace(/[‚Äì‚Äî]/g,"-")
    .replace(/\s+/g," ")
    .trim();

  const cap = extractCapacity(s);
  if (cap){
    const idx = s.toUpperCase().indexOf(cap);
    if (idx > 0) s = s.slice(0, idx).trim();
  }

  const up = s.toUpperCase();
  if (!up.includes("IPHONE") && (/^\d{2}\b/.test(s) || up.startsWith("12") || up.startsWith("13") || up.startsWith("14") || up.startsWith("15") || up.startsWith("16") || up.startsWith("17"))){
    s = `iPhone ${s}`.replace(/\s+/g," ").trim();
  }

  s = capitalizeBrand(s);
  s = s.replace(/\bPRO\s+MAX\b/ig,"Pro Max")
       .replace(/\bPRO\b/ig,"Pro")
       .replace(/\bPLUS\b/ig,"Plus")
       .replace(/\bMINI\b/ig,"mini");

  return s;
}

function displayTitle(item){
  const model = cleanModelOnly(item.title || item.raw);
  const cap = extractCapacity(item.title || item.raw);
  const colors = colorsTextForMessage(item);

  const left = [model, cap].filter(Boolean).join(" ‚Ä¢ ");
  if (colors) return `${left} ‚Ä¢ ${colors}`;
  return left;
}

function modelForMessage(item){
  const model = cleanModelOnly(item.title || item.raw);
  const cap = extractCapacity(item.title || item.raw);
  return cap ? `${model} ‚Äì ${cap}` : model;
}

function lineGroupFor(title){
  const t = (title||"").toUpperCase();
  const n = (t.match(/\b(1[0-9])\b/) || [])[1];
  if (!n) return "OUTROS";
  return `LINHA ${n}`;
}

function parseList(rawText, sourceName){
  const lines = rawText.split("\n").map(normalizeLine);

  let status = DEFAULT_STATUS;
  let category = "Geral";

  const data = {};

  for (let i=0; i<lines.length; i++){
    const line = lines[i];
    if (!line) continue;

    const st = detectStatus(line);
    if (st) status = st;

    if (isCategoryLine(line)){
      category = parseCategory(line);
      continue;
    }

    const guessCat = guessCategoryFromText(line);
    if (guessCat && !/^(üìç|üì≤|üì±)\s*/.test(line)){
      category = guessCat;
      continue;
    }

    if (line === "---" || /^[-‚Äî_]{6,}$/.test(line)) continue;

    if (/^(üìç|üì≤|üì±)\s*/.test(line)){
      const item = parseItemLine(line);

      item.source = sourceName;
      item.status = status;
      item.category = category;
      item.lineGroup = lineGroupFor(item.title);

      item.colorsWords = extractColorsFromWords(item.raw);

      let emojiColors = [];
      const next = lines[i+1] || "";
      if (next && extractColorsFromEmojiLine(next).length){
        emojiColors = extractColorsFromEmojiLine(next);
      }
      item.colorsEmoji = emojiColors;

      item.isUpgrade = /\bUPGRADE\b/i.test(item.raw) || /\bUPGRADE\b/i.test(item.title);

      data[status] ??= {};
      data[status][category] ??= [];
      data[status][category].push(item);

      continue;
    }
  }

  return { data };
}

/** =========================
 *  4) COPY
 *  ========================= */
function showToast(text){
  const el = document.getElementById("toast");
  el.textContent = text || "Mensagem copiada ‚úÖ";
  el.classList.add("show");
  clearTimeout(showToast._t);
  showToast._t = setTimeout(()=> el.classList.remove("show"), 1400);
}
async function copyText(text){
  try{
    await navigator.clipboard.writeText(text);
    showToast("Mensagem copiada ‚úÖ");
  }catch(e){
    window.prompt("Copie a mensagem:", text);
  }
}

/* ‚úÖ S√≥ retorna "R$ xxx,xx" da parcela 12x */
function buildInstallment12Only(item){
  const cash = parseBRL(item.price);
  const calc = calcParcela12FromCash(cash);
  if (!calc) return "";
  return formatBRL(calc.parcela);
}

function buildMessage(item){
  const model = modelForMessage(item);
  const price = item.price || "R$ (consultar)";
  const colorsTxt = colorsTextForMessage(item);
  const installment12Txt = buildInstallment12Only(item);

  if (item.status === "SEMINOVOS") return TEMPLATE_SEMINOVO(model, price, installment12Txt, colorsTxt);
  return TEMPLATE_LACRADO(model, price, installment12Txt, colorsTxt);
}

/** =========================
 *  5) RENDER
 *  ========================= */
function escapeHtml(str){
  return String(str || "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function formatUpdatedPill(){
  const d = new Date();
  const br = d.toLocaleDateString("pt-BR", { day:"2-digit", month:"2-digit", year:"numeric" });
  document.getElementById("updatedPill").textContent = `üìå Atualiza√ß√£o: ${br}`;
}

function countItems(block){
  let c = 0;
  for (const cat in block) c += block[cat].length;
  return c;
}

function catWeight(cat){
  const u = cat.toUpperCase();
  if (u.includes("IPHONE")) return 1;
  if (u.includes("REL√ìG") || u.includes("RELOG")) return 2;
  if (u.includes("IPAD")) return 3;
  if (u.includes("MAC")) return 4;
  return 9;
}

function cardHtml(it, key){
  const isSemi = it.status === "SEMINOVOS";
  const badgeText = isSemi ? "Seminovo" : "Lacrado";
  const badgeClass = isSemi ? "seminovo" : "lacrado";

  const colorsTxt = colorsTextForMessage(it);

  const chips = [];
  (it.colorsWords || []).slice(0,6).forEach(c=> chips.push(`<span class="chip">${escapeHtml(c)}</span>`));
  (it.colorsEmoji || []).slice(0,10).forEach(e=>{
    const name = EMOJI_COLOR_MAP.get(e);
    chips.push(`<span class="chip">${escapeHtml(e)}${name ? " "+escapeHtml(name) : ""}</span>`);
  });

  const upgradeBadge = it.isUpgrade ? `<div class="badge upgrade">UPGRADE</div>` : "";
  const installment12 = buildInstallment12Only(it);

  return `
    <article class="card">
      <div class="badge ${badgeClass}">${badgeText}</div>
      ${upgradeBadge}
      <h4 class="name">${escapeHtml(displayTitle(it))}</h4>
      <p class="details">${colorsTxt ? `Cores: ${escapeHtml(colorsTxt)}` : ""}</p>
      ${chips.length ? `<div class="chips">${chips.join("")}</div>` : ""}
      <div class="price-row">
        <div class="price">
          <span>${escapeHtml(it.price || "Consultar")}</span>
          ${installment12 ? `<span class="installment">12x de ${escapeHtml(installment12)}</span>` : ""}
        </div>
        <button class="copy" type="button" data-key="${escapeHtml(key)}">üìã Copiar</button>
      </div>
    </article>
  `;
}

function renderBlock(container, cfg, parsed){
  const data = parsed.data;
  const statusOrder = ["LACRADOS","SEMINOVOS"];
  const index = new Map();

  const html = statusOrder
    .filter(st => data[st] && Object.keys(data[st]).length)
    .map(st=>{
      const block = data[st];
      const total = countItems(block);
      const cats = Object.keys(block).sort((a,b)=>catWeight(a)-catWeight(b) || a.localeCompare(b,"pt-BR"));

      const catsHtml = cats.map(cat=>{
        const items = block[cat];

        const byLine = {};
        for (const it of items){
          const g = it.lineGroup || "OUTROS";
          byLine[g] ??= [];
          byLine[g].push(it);
        }
        const lineKeys = Object.keys(byLine).sort((a,b)=>{
          const na = parseInt((a.match(/\d+/)||[])[0]||"999",10);
          const nb = parseInt((b.match(/\d+/)||[])[0]||"999",10);
          return na - nb;
        });

        const onlyOutros = lineKeys.length === 1 && lineKeys[0] === "OUTROS";

        if (!onlyOutros){
          const linesHtml = lineKeys.map(lk=>{
            const cards = byLine[lk].map((it,i)=>{
              const key = `${cfg.key}::${st}::${cat}::${lk}::${i}`;
              index.set(key, it);
              return cardHtml(it, key);
            }).join("");
            return `
              <div class="line-block">
                <div class="line-title">${escapeHtml(lk)}</div>
                <div class="grid">${cards}</div>
              </div>
            `;
          }).join("");

          return `
            <details class="cat">
              <summary>
                <div class="cat-left">
                  <div class="cat-title">${escapeHtml(cat)}</div>
                  <div class="cat-sub">${items.length} itens</div>
                </div>
                <div class="count">Toque para abrir</div>
              </summary>
              ${linesHtml}
            </details>
          `;
        }

        const cards = items.map((it,i)=>{
          const key = `${cfg.key}::${st}::${cat}::${i}`;
          index.set(key, it);
          return cardHtml(it, key);
        }).join("");

        return `
          <details class="cat">
            <summary>
              <div class="cat-left">
                <div class="cat-title">${escapeHtml(cat)}</div>
                <div class="cat-sub">${items.length} itens</div>
              </div>
              <div class="count">Toque para abrir</div>
            </summary>
            <div class="line-block">
              <div class="grid">${cards}</div>
            </div>
          </details>
        `;
      }).join("");

      const h3Class = st === "LACRADOS" ? "h3-blue" : "h3-green";
      const label = st === "LACRADOS" ? "üì¶ Lacrados" : "‚ú® Seminovos";

      return `
        <div class="section">
          <div class="section-head">
            <h3 class="${h3Class}">${label}</h3>
            <div class="count">${total} itens</div>
          </div>
          ${catsHtml}
        </div>
      `;
    }).join("");

  container.innerHTML = `
    <div class="block">
      <div class="block-head">
        <div class="block-left">
          <div class="store-badge ${cfg.badgeClass}">${cfg.icon} ${escapeHtml(cfg.title)}</div>
          <div class="block-sub">Toque em ‚ÄúCopiar‚Äù para mensagem pronta</div>
        </div>
        <div class="block-sub">Cores exibidas conforme a lista</div>
      </div>
      ${html || `<div class="section"><div class="foot">Nenhum item encontrado nesta lista.</div></div>`}
      <div class="foot">Valores √† vista ‚Ä¢ Parcelamento: consultar</div>
    </div>
  `;

  container.querySelector(".block").addEventListener("click",(e)=>{
    const btn = e.target.closest("button.copy");
    if (!btn) return;
    const key = btn.getAttribute("data-key");
    const item = index.get(key);
    if (!item) return;
    copyText(buildMessage(item));
  }, { passive:true });
}

function render(){
  formatUpdatedPill();

  const app = document.getElementById("app");
  app.innerHTML = "";

  const parsedManga = parseList(RAW_MANGA, "MANGA");
  const parsedTech  = parseList(RAW_TECH, "ImportTech");

  const mangaWrap = document.createElement("div");
  const techWrap  = document.createElement("div");

  renderBlock(mangaWrap, { key:"MANGA", title:"Aparelhos MANGA", badgeClass:"manga", icon:"ü•≠" }, parsedManga);
  renderBlock(techWrap,  { key:"TECH",  title:"Aparelhos ImportTech", badgeClass:"tech",  icon:"‚ö°" }, parsedTech);

  app.appendChild(mangaWrap);
  app.appendChild(techWrap);
}

render();
</script>
</body>
</html>
